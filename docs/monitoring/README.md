# Monitoring & Incident Management

- `chien-luoc-observability.md`: kiến trúc thu thập metric, log, alert cho toàn bộ stack dữ liệu (Prometheus, Grafana, Loki, Alertmanager, exporters).
- `incident-runbook.md`: quy trình xử lý sự cố chuẩn, kịch bản phổ biến và checklist hậu kiểm.
- `case-kafka-lag.md`: ví dụ sử dụng hệ thống observability để xử lý cảnh báo consumer lag cao.

## Khởi động stack observability
- `docker compose -f docker-compose.yml -f docker-compose.monitoring.yml up -d` để bật toàn bộ dịch vụ kèm exporters.
- Truy cập Grafana tại http://localhost:3000 (admin/admin12345), Prometheus tại http://localhost:9090.
- Prometheus hiện thu thập metric từ Flink (9249/9250), Kafka (9308), Spark master/worker, Cassandra (9500-9502), MySQL (9104), PostgreSQL (9187), MinIO (9000), Doris (8030), Kafka Connect (9404), Trino (9405) cùng các HTTP probe (blackbox exporter) kiểm tra MinIO, Nessie, Doris, Trino, Connect, Spark, Flink.
- Tất cả microservice HTTP nay đều có endpoint `/health`; `docker compose ps --format "table {{.Name}}\t{{.State}}\t{{.Health}}"` giúp theo dõi trạng thái. Compose đã cấu hình `depends_on.condition: service_healthy` nên container downstream chỉ khởi động khi dependency ở trạng thái `healthy`, giảm lỗi race sau khi restart.
- Grafana dashboard `Dataflow Overview` đã bổ sung panel cho Cassandra/Paimon (qua Flink job), MySQL, PostgreSQL, Kafka Connect, Trino, MinIO, tình trạng HTTP probe, nhóm panel "Notification" (send rate, rate limited, drops, opt-outs, rate limiter errors) và các panel "Support timeline p95 latency", "Support attachment backlog", "Support timeline cache events", "Support timeline failure stages" để hỗ trợ vận hành end-to-end.
- Prometheus rule group `dataflow-runtime`/`support-service` bổ sung các alert `NotificationFailureRateHigh`, `NotificationRateLimitedBurst`, `NotificationOptOutSpike`, `NotificationRateLimiterErrors`, `SupportTimelineLatencyHigh`, `SupportTimelineCollectionFailures`, `SupportTimelineCacheErrors`, `SupportAttachmentBacklogHigh`, `SupportAttachmentGrowthRapid` giúp SRE phản ứng sớm với sự cố dịch vụ Notification/Support.
- Alert routing: Alertmanager được cấu hình gửi mọi alert có `severity=high|critical` đến Slack channel `#data-ops`. Đồng thời alert `severity=warning|high|critical` sẽ được gửi email (receiver `email-oncall`) và Microsoft Teams (receiver `teams-oncall`). Stack sử dụng template `monitoring/alertmanager/alertmanager.yml.tmpl` và script `monitoring/alertmanager/entrypoint.sh` để render config từ biến môi trường (`ALERTMANAGER_SLACK_WEBHOOK_URL`, `ALERTMANAGER_EMAIL_FROM`, `ALERTMANAGER_EMAIL_TO`, `ALERTMANAGER_SMTP_SMARTHOST`, `ALERTMANAGER_SMTP_USERNAME`, `ALERTMANAGER_SMTP_PASSWORD`, `ALERTMANAGER_TEAMS_WEBHOOK_URL`). Nếu để trống, script sẽ hiển thị cảnh báo và giữ nguyên placeholder (`alerts@example.com`, `smtp.example.com:587`, webhook giả lập) khiến cảnh báo không gửi được; hãy đặt biến thật (hoặc cấu hình trong `.env`) trước khi deploy. Có thể chạy `docker compose -f docker-compose.yml -f docker-compose.monitoring.yml run --rm alertmanager --version` để xác nhận config render thành công, hoặc `ALERTMANAGER_RENDER_ONLY=1 docker compose -f docker-compose.yml -f docker-compose.monitoring.yml run --rm alertmanager` để in ra file config đã render phục vụ kiểm tra trước khi bật stack.
- Synthetic monitoring: script `scripts/synthetic/support_timeline_probe.py` tạo ticket kiểm thử, đo độ trễ timeline và trả JSON report. Có thể chạy cục bộ bằng `make support-probe ARGS="--base-url http://support:8000"` hoặc thông qua workflow GitHub Actions định kỳ `Support Synthetic Probe` (cron 02:00 UTC) để phát hiện sớm vấn đề timeline. Song song, `scripts/synthetic/notification_probe.py` gửi thử notification end-to-end, xác nhận metric `notification_sent_total`/`notification_send_latency_seconds_count` tăng đúng và không phát sinh lỗi. Chạy bằng `make notification-probe ARGS="--base-url http://notification:8000"` hoặc workflow `Notification Synthetic Probe` theo lịch.
- Synthetic data: `scripts/synthetic/generate_support_cases.py` tạo loạt ticket giả lập (có thể thêm tin nhắn follow-up) nhằm nuôi dữ liệu cho dashboard Support; chạy bằng `make support-generate ARGS="--count 10 --messages-per-ticket 2"`.
- Chaos drill: `scripts/chaos/notification_provider_failure.py` tạo notification synthetic và gọi `/fail` để mô phỏng lỗi provider, giúp kiểm tra alert `NotificationFailureRateHigh`/dashboard. Có thể chạy cục bộ bằng `make notification-chaos-provider ARGS="--base-url http://notification:8000 --count 10"`; script trả về JSON gồm danh sách notification Id và delta metric `notification_failure_total`.
- Chaos drill: `scripts/chaos/notification_redis_outage.py` tạm dừng service Redis (qua Docker Compose), gửi loạt notification khi rate limiter mất backend và đảm bảo metric `notification_rate_limit_errors_total{operation=*}` tăng. Dùng `make notification-chaos-redis ARGS="--base-url http://notification:8000"` (có thể thêm `--no-manage-redis` khi tự điều phối outage). Script tự khởi động lại Redis và kiểm tra lại readiness.
- Chaos drill: `scripts/chaos/simulate_replication_lag.py` tạm dừng các connector Debezium qua REST API, ghi thêm dữ liệu vào MySQL khi CDC ngừng chạy, chờ `pause_duration` rồi resume. Script báo cáo trạng thái connector, delta binlog position và số dòng đã chèn giúp kiểm chứng alert/ dashboard replication lag. Chạy bằng `make chaos-replication-lag ARGS="--connect-url http://connect:8083 --rows 100"`. Runbook chi tiết: `docs/runbooks/replication-lag.md`.
- Chaos drill: `scripts/chaos/simulate_schema_drift.py` thêm hoặc gỡ bỏ cột bất ngờ trên bảng MySQL (ví dụ `oltp.orders`) để mô phỏng producer schema drift làm Debezium/Kafka consumer lỗi. Dùng `make chaos-schema-drift ARGS="--table oltp.orders --column unexpected_field"`; sau diễn tập có thể hoàn tác bằng `--revert`. Runbook chi tiết: `docs/runbooks/schema-drift.md`.
- Chaos drill: `scripts/chaos/simulate_ttl_oversell.py` thay đổi `default_time_to_live` bảng Cassandra (ví dụ `inventory.reservations`) để reservations hết hạn quá nhanh → mô phỏng oversell. Chạy `make chaos-ttl-oversell ARGS="--keyspace inventory --table reservations --ttl 60"` và quan sát alert `InventoryOversellRisk`; script hỗ trợ `--revert --previous-ttl <value>` để khôi phục TTL. Runbook chi tiết: `docs/runbooks/ttl-oversell.md`.
- Chaos drill: `scripts/chaos/simulate_fulfillment_delay.py` giữ nhãn vận chuyển/packing slip trong MinIO để tạo backlog `fulfillment_lag_minutes`. Chạy `make chaos-fulfillment-delay ARGS="--count 25 --hold-minutes 30"` (có thể chỉ định `--support-ticket-id <id>` để gọi API support và ghi nhận timeline). Sử dụng `--revert` để xoá các object đã sinh, `--dry-run` để xem kế hoạch trước khi thao tác thực tế. Runbook chi tiết: `docs/runbooks/fulfillment-delay.md`.
- (TODO) Finance reconciliation delay drill sẽ được bổ sung sau khi job batching hoàn thiện. Tạm thời vận hành dựa trên runbook `docs/runbooks/reconciliation-delay.md` khi metric `finance_reconciliation_age_minutes` vượt ngưỡng.
- Bảo trì định kỳ: script `scripts/maintenance/offload_support_attachments.py` hỗ trợ offload file đính kèm quá hạn sang thư mục archive/cold storage, đồng thời cập nhật metric backlog. Dùng `make support-offload ARGS="--dry-run"` để audit hoặc `--age-days <n>` khi thực sự di chuyển; workflow `Support Synthetic Probe` cũng chạy `--dry-run` mỗi đêm để đảm bảo script luôn hoạt động.

Sử dụng chung với tài liệu use case để xác định phạm vi ảnh hưởng và hành động phù hợp khi xảy ra sự cố.
